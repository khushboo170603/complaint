{% extends base_form_template %}
{% load widget_tweaks %}

{% block title %}Register Complaint{% endblock %}

{% block content %}
<div class="flex justify-center items-center min-h-[70vh] mt-24">
    <div class="bg-white shadow-md rounded-lg p-8 w-full max-w-2xl">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Complaint Registration</h2>

        <form method="post" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}

            {% for field in form %}
                {% if field.name in 'latitude longitude customer_address' %}
                    {# Skip these fields completely #}
                {% else %}
                    <div>
                        <label for="{{ field.id_for_label }}" class="block font-medium text-gray-700 mb-1">
                            {{ field.label }}{% if field.field.required %} *{% endif %}
                        </label>

                        {% if field.name == 'pincode' %}
                            {{ field|add_class:"w-full px-4 py-2 border border-blue-500 rounded" }}
                        {% elif field.name in 'city state' %}
                            {{ field|add_class:"w-full px-4 py-2 border border-green-500 rounded" }}
                        {% else %}
                            {{ field|add_class:"w-full px-4 py-2 border border-gray-300 rounded" }}
                        {% endif %}

                        {% if field.help_text %}
                            <small class="text-gray-500">{{ field.help_text }}</small>
                        {% endif %}

                        {% if field.errors %}
                            <p class="text-red-600 text-sm">{{ field.errors.0 }}</p>
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}

            <div class="flex justify-between gap-4">
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">
                    Submit Complaint
                </button>
                <a href="{{ back_url }}" class="w-full bg-gray-300 text-gray-800 py-2 rounded text-center hover:bg-gray-400 transition">
                   ⬅️ Back
                </a>
            </div>
        </form>
    </div>
</div>

<script>
async function fetchAddressData(inputType) {
    const pincode = document.getElementById('id_pincode').value;
    const city = document.getElementById('id_city').value;
    const state = document.getElementById('id_state').value;

    if (inputType === 'pincode' && pincode.length === 6) {
        const res = await fetch(`https://api.postalpincode.in/pincode/${pincode}`);
        const data = await res.json();
        if (data[0].Status === "Success") {
            const postOffice = data[0].PostOffice[0];
            document.getElementById('id_city').value = postOffice.District;
            document.getElementById('id_state').value = postOffice.State;
        }
    }

    if (inputType === 'citystate' && city && state) {
        const res = await fetch(`https://api.postalpincode.in/postoffice/${city}`);
        const data = await res.json();
        if (data[0].Status === "Success") {
            const match = data[0].PostOffice.find(p => p.State.toLowerCase() === state.toLowerCase());
            if (match) {
                document.getElementById('id_pincode').value = match.Pincode;
            }
        }
    }
}

// Auto trigger
document.getElementById('id_pincode').addEventListener('change', () => fetchAddressData('pincode'));
document.getElementById('id_city').addEventListener('change', () => fetchAddressData('citystate'));
document.getElementById('id_state').addEventListener('change', () => fetchAddressData('citystate'));
</script>
{% endblock %}
